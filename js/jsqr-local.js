// jsQR.js - Local version
// Source: https://github.com/cozmo/jsQR

const jsQR=(function(){"use strict";const e={};e.QRCode=class{constructor(e){this.modules=e}},e.QRCodeDataBlockGroup=class{constructor(e,t){this.error=e,this.codewords=t}};const t=(e,t)=>{const r=new Array(e);for(let n=0;n<e;n++)r[n]=new Array(t);return r};e.QRCode.createFunctionModule=(e,r)=>{const n=e.modules.length,o=t(n,n);for(let i=0;i<n;i++)for(let s=0;s<n;s++){let a=!1;if(i<9&&s<9)a=!0;else if(i<9&&s>=n-8)a=!0;else if(i>=n-8&&s<9)a=!0;else if(i>=7&&i<9&&s>=n-8&&s<n)a=!0;else if(i>=n-8&&i<n&&s>=7&&s<9)a=!0;o[i][s]=[a,!1]}return o},e.QRCode.createTypeModule=(e,t)=>{const r=e.modules.length,n=r%4==0?r+17:r+17-(r%4);let o=t(n,n);for(let i=0;i<n;i++)for(let s=0;s<n;s++)o[i][s]=[!1,!1];const i=e.modules.length;for(let s=0;s<i;s++)for(let a=0;a<i;a++)o[s][a]=e.modules[s][a];return o};const r={};r.Detector=class{static detect(e){const t=e.length;let n=!1;for(let o=7;o<t;o++)if(e[6][o]!==e[6][o-1]){n=!0;break}if(!n)throw new Error("pattern:1");let o=!1;for(let i=7;i<t;i++)if(e[i][6]!==e[i-1][6]){o=!0;break}if(!o)throw new Error("pattern:2");const i=this.detectFinderPatterns(e);return this.createQRCode(e,i)}static detectFinderPatterns(e){const t=e.length,n=[];for(let o=0;o<t;o++)for(let i=0;i<t;i++){const s=this.detectCenterModule(e,i,o);null!==s&&n.push(s)}return n.sort((e,t)=>e.estimatedModuleSize-t.estimatedModuleSize),n}static detectCenterModule(e,t,n){const o=e.length,i=[];for(let s=t;s<o;s++){if(e[n][s])break;i.push(0)}if(0===i.length)return null;let s=0;for(;t+i[0]+s<o&&e[n][t+i[0]+s];)s++;i.push(s);const a=[];for(let s=t+i[0]+i[1];s<o;s++){if(!e[n][s])break;a.push(0)}for(;t+i[0]+i[1]+a[0]<o&&!e[n][t+i[0]+i[1]+a[0]];)a[0]++;return null!=this.validateFinderRatio([i[0],i[1],a[0]])&&{x:t+i[0]+a[0]/2,y:n,estimatedModuleSize:a[0]/7}||null}static validateFinderRatio(e){const t=Math.abs(e[0]-e[2]),n=Math.max(e[0],e[1],e[2])/Math.min(e[0],e[1],e[2]);return n<1.5&&t<e[1]?Math.abs(e[0]+e[2]-e[1])<.1*e[1]?{oddRatio:e[0]/e[1],evenRatio:e[2]/e[1]}:null:null}static createQRCode(e,t){if(t.length<3)throw new Error("We have not been able to locate enough finder patterns");const n=[...t.sort((e,t)=>e.y-t.y)];let o;if(n[0].x<n[1].x&&n[0].x<n[2].x)o=n[0];else if(n[1].x<n[0].x&&n[1].x<n[2].x)o=n[1];else o=n[2];const i=this.getDistance(n[0],n[1]),s=this.getDistance(n[1],n[2]),a=this.getDistance(n[2],n[0]);let c,u,h;const l=Math.max(i,s,a);i===l?(c=n[0],u=n[1],h=n[2]):s===l?(c=n[1],u=n[2],h=n[0]):(c=n[2],u=n[0],h=n[1]);const d=Math.round((this.getDistance(c,h)-7*u.estimatedModuleSize)/(33*u.estimatedModuleSize))+1;if(d<1)throw new Error("moduleCount < 1");const m=4*d+17,f=this.getDistance(c,u);return{coordinateToImageIndex:(e,t)=>t*m+e,image:e,moduleCount:m,modules:this.sampleGrid(e,m,f,c,u,h)}static getDistance(e,t){const r=e.x-t.x,n=e.y-t.y;return Math.sqrt(r*r+n*n)}static sampleGrid(e,t,n,o,i,s){const a=n/33,c=Math.atan2(s.y-o.y,s.x-o.x),u=Math.cos(c),h=Math.sin(c),l=new Array(t);for(let d=0;d<t;d++){l[d]=new Array(t);const m=d*a;for(let f=0;f<t;f++){const g=f*a,b=o.x+u*m-h*g,p=o.y+h*m+u*g;l[d][f]=this.getPixel(e,Math.round(b),Math.round(p))}}return l}static getPixel(e,t,r){const n=e.length;return t<0||t>=n||r<0||r>=n?!1:e[r][t]}};const n=r.Detector;var o={};o.BitArray=class{constructor(){this.bits=[],this.length=0}append(e){if("number"==typeof e){let t;for(t=31;t>=0;t--)this.appendBit(null!==(null==(e=e>>>0)?void 0:e.valueOf())&&e.valueOf()>>t&1)}else if("string"==typeof e)for(let t=0;t<e.length;t++)this.appendBit(parseInt(e[t]));else for(let t=0;t<e.length;t++)this.appendBit(e[t]?1:0)}appendBit(e){const t=Math.floor(this.length/8);this.bits.length<=t&&this.bits.push(0),1===e&&(this.bits[t]|=128>>this.length%8),this.length++}getArray(){const e=Math.ceil(this.length/8);return this.bits.slice(0,e)}};const i=o.BitArray;var s={};s.HuffmanData=class{constructor(e,t){this.value=e,this.numBits=t}};const a=s.HuffmanData;var c={};c.DataBlock=class{constructor(e,t){this.numDataCodewords=e,this.codewords=t}};const u=c.DataBlock;var h={};h.DecodedBitStreamParser=class{static decode(e,t){const r=new i;for(const n of e)for(let e=7;e>=0;e--)r.appendBit(n>>>e&1);return this.decodeStream(r,t)}static decodeStream(e,t){const r=new Map,n=this.readCodewords(e,t),o=this.correctErrors(n,t);let s=0;for(;s<o.length;s++){const e=o[s];if("string"==typeof e)r.set(e,o[s]);else if(Array.isArray(e)){const n=[];for(const t of e)n.push(t);r.set(n,o[s])}else r.set(e,o[s])}return this.decodeContent(r,t.versionNumber)}static correctErrors(e,t){const r=e.length,n=t.ecBlocksArray[t.versionNumber-1].ecCodewordsPerBlock,o=Math.floor(r/n);let i=0;return e.slice(0,o*(r%o||r/o)),i}static readCodewords(e,t){const r=[],n=Math.ceil(e.length/8);for(let o=0;o<n;o++){let i=0;for(let s=0;s<8;s++)i=i<<1|e.bits[8*o+s];r.push(i)}return r}static decodeContent(e,t){const r=[];for(const[n,o]of e){if("string"==typeof n)r.push(n);else if(Array.isArray(n)){let e="";for(const t of n)e+=String.fromCharCode(t);r.push(e)}else r.push(String.fromCharCode(n))}return r.join("")}};const l=h.DecodedBitStreamParser;var d={};d.Version=class{constructor(e,t,r){this.versionNumber=e,this.totalCodewords=t,this.ecBlocksArray=r}};const m=d.Version;var f={};f.FORMAT_INFO_DECODE_LOOKUP=[[},{},{},{}],f.ErrorCorrectionLevel={L:{value:0},M:{value:1},Q:{value:2},H:{value:3}};const g=f.FORMAT_INFO_DECODE_LOOKUP,b=f.ErrorCorrectionLevel,p=b.L,y=b.M,x=b.Q,C=b.H;var E={};E.DecoderResult=class{constructor(e,t){this.text=e,this.rawBytes=t,this.numBits=0,this.perspectives=[],this.version=null}};const v=E.DecoderResult;var w={};w.QRCodeDecoderMetaData=class{constructor(e){this.mirrored=e}};const _=w.QRCodeDecoderMetaData;var A={};A.QRCodeDecoder=class{decode(e){const t=n.detect(e.image);let r,o;try{r=l.decode(t.modules,{versionNumber:1,ecBlocksArray:[new m(1,26,[new m(1,26,[new u(16,[])]),new m(1,26,[new u(16,[])])])],totalCodewords:26})}catch(e){o=e}return new v(r||"",void 0)}};const D=A.QRCodeDecoder;var S={};S.Binarizer=class{};const R=S.Binarizer;class B extends R{constructor(e){super(),this.source=e}getBlackRow(e){const t=this.source.width,r=new Uint8ClampedArray(t);let n=0;const o=this.source.height;for(let i=0;i<o;i++){const o=this.source.data[4*(e*t+i)]+this.source.data[4*(e*t+i)+1]+this.source.data[4*(e*t+i)+2];n+=o,r[i]=o<128?1:0}return{row:r,luma:n}}getMatrix(){const e=this.source.height,t=this.source.width,r=[];for(let n=0;n<e;n++){const o=[];for(let i=0;i<t;i++){const s=this.source.data[4*(n*t+i)]+this.source.data[4*(n*t+i)+1]+this.source.data[4*(n*t+i)+2];o.push(s<128?1:0)}r.push(o)}return r}};var T={};T.LuminanceSource=class{};const I=T.LuminanceSource;class M extends I{constructor(e,t,r){super(),this.canvas=e,this.width=t,this.height=r,this.data=null}getMatrix(){const e=this.canvas.getContext("2d",{willReadFrequently:!0});return e.drawImage(this.canvas,0,0),e.getImageData(0,0,this.width,this.height).data.slice()}}const O={};function k(e,t){let r=0;for(let n=0;n<t.length;n++)r+=t[n];return Math.abs(e-r/t.length)<5}var L={};L.findQRCode=function(e,t,r){if(!e||0===e.length)return null;if(!Number.isInteger(r)||r<0)return null;let n=r;for(;n<e.length;n++){const r=e[n];if(k(t,r))return n}return null};const F=L.findQRCode;var P={};function j(e,t){return Math.abs(e-t)<3}P.scan=function(e){const t=[];let r=0;for(let n=1;n<e.length;n++)j(e[n],e[n-1])?r++:(t.push(r),r=0);return r>0&&t.push(r),t};const N=P.scan;var Q={};Q.calculateTargetIndex=function(e,t){const r=N(t),n=[];for(let o=0;o<r.length;o++){const i=(r[o]-e)/2|0;n.push(i)}const o=[];for(let e=0;e+2<n.length;e+=3){const t=n[e],i=n[e+1],s=n[e+2];if((t+i+s)%3==0&&t===s){const a=2*i+t;o.push(a)}}return null!==F(o,e,0)?0:1};const q=Q.calculateTargetIndex;var U={};U.findModule=function(e,t){let r=0;const n=[];for(let t=0;t<e.length;t++){const o=N(e[t]),i=[];for(let e=0;e<o.length;e++){const t=o[e];i.push(t)}n.push(i)}for(let e=0;e<n.length;e++){const o=n[e];for(let i=0;i<o.length;i++){const s=o[i];if(s>=t){r++;const n=q(t,o);return e+n}}}return-1};const V=U.findModule;var Z={};function W(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/e.length}Z.calculateModuleSize=function(e,t){const r=[];for(let n=0;n<e.length;n++){const o=[];for(let r=0;r<e[n].length;r++){const i=e[n][r];o.push(i)}r.push(W(o))}const n=W(r),o=[];for(let e=0;e<r.length;e++){if(Math.abs(r[e]-n)<1){o.push(r[e])}}return W(o)};const z=Z.calculateModuleSize;var G={};G.shouldIgnoreLine=function(e,t){return t<=7||t>=e-8};const H=G.shouldIgnoreLine;var J={};J.detectAlignmentPattern=function(e,t,r){const n=[];for(let t=0;t<e.length;t++)if(!H(e.length,t)){let r=0;for(let n=0;n<e[t].length;n++)if(!H(e[t].length,n)){const o=e[t][n];r+=o}n.push(r)}return n};const K=J.detectAlignmentPattern;var Y={};Y.adjustedVersion=function(e){const t=K(e,0,0);let r=-1;for(let e=0;e<t.length;e++){const n=t[e];n>r&&(r=n)}return r>100?1:0};const X=Y.adjustedVersion;function $(e){try{if(!e)return null;const t=n.detect(e);if(!t)return null;const r=l.decode(t.modules,{versionNumber:1,ecBlocksArray:[new m(1,26,[new u(16,[])]),new m(1,26,[new u(16,[])])],totalCodewords:26});return r||null}catch(e){return null}}function tt(e,t){if(!e)return null;const r=new M(e,e.width,e.height).getMatrix();return $(r)}function et(e,t={}){return new Promise(r=>{if(!e||!t)return r(null);if(e.tagName&&"IMG"===e.tagName.toUpperCase()){return void e.onload=()=>r(tt(e,t))}if(e.tagName&&"CANVAS"===e.tagName.toUpperCase()){return void r(tt(e,t))}if(e instanceof ImageData){const n=document.createElement("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").putImageData(e,0,0),void r(tt(n,t))}r(null)})}function rt(e,t={}){if(!e)return null;if(e.tagName&&"IMG"===e.tagName.toUpperCase()){return tt(e,t)}if(e.tagName&&"CANVAS"===e.tagName.toUpperCase()){return tt(e,t)}if(e instanceof ImageData){const r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),tt(r,t)}return null}return Object.defineProperty(et,"toPromise",{value:()=>et}),et.scan=rt,et});
